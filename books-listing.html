<!DOCTYPE html>
<html lang="he">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="index.css">
</head>
<script>
    $(document).ready(function() {
        var endpoint = 'https://jewishoffice.co.il/server/bookapi/?type=categories';

        $.ajax({
            url: endpoint,
            contentType: "application/json",
            dataType: 'json',
            cache: false,
            success: function(result) {
                console.log(result);

                if (Array.isArray(result)) {
                    result.forEach(cat => {
                        if ('ID' in cat && 'name' in cat) {
                            str = '<option id=' + cat.ID.toString() + '>';
                            str += cat.name;
                            str += '</a></option>';

                            $('#categories option:last').after(str);
                        }
                    });
                }
            },
            error: function(data, err) {
                console.log(err);
                alert(JSON.stringify(data));
                alert(JSON.stringify(err));
            }
        });

        $('#categories').change(function() {
            var $sel = $('#categories option:selected');

            if ($sel) { //} && Array.isArray($sel)) {
                var opt = $sel[0];

                if ('id' in opt) {
                    var id = opt.id;

                    if (id > 0) {
                        var endpoint = 'https://jewishoffice.co.il/server/bookapi/?category=' + id.toString() + '&page=1&mode=name';

                        //window.location.replace('https://jewishoffice.co.il/server/bookapi/?category=' + id.toString() + '&page=1&mode=name');
                        $.ajax({
                            url: endpoint,
                            contentType: "application/json",
                            dataType: 'json',
                            cache: false,
                            success: function(result) {
                                console.log(result);

                                if ('books' in result) {
                                    var books = result.books;

                                    books.forEach(b => {
                                        if ('id' in b && 'name' in b) {
                                            str = '<option id=' + b.id.toString() + '>';
                                            str += b.name;
                                            str += '</a></option>';

                                            $('#books option:last').after(str);
                                        }
                                    });
                                }
                            },
                            error: function(data, err) {
                                console.log(err);
                                alert(JSON.stringify(data));
                                alert(JSON.stringify(err));
                            }
                        });
                    }
                }
            }
            //&&  'id' in $sel)
            //alert($sel.id);
            //https://jewishoffice.co.il/server/bookapi/?category=1&page=1&mode=name
        });

        $('#books').change(function() {
            var $sel = $('#books option:selected');

            if ($sel) { //} && Array.isArray($sel)) {
                var opt = $sel[0];

                if ('id' in opt) {
                    var id = opt.id;

                    if (id > 0) {
                        var endpoint = 'https://jewishoffice.co.il/server/bookapi/?book=' + id.toString();

                        //window.location.replace('https://jewishoffice.co.il/server/bookapi/?category=' + id.toString() + '&page=1&mode=name');
                        $.ajax({
                            url: endpoint,
                            contentType: "application/json",
                            dataType: 'json',
                            cache: false,
                            success: function(result) {
                                console.log(result);

                                if ('books' in result) {
                                    var books = result.books;

                                    books.forEach(b => {
                                        if ('id' in b && 'name' in b) {
                                            str = '<option id=' + b.id.toString() + '>';
                                            str += b.name;
                                            str += '</a></option>';

                                            $('#books option:last').after(str);
                                        }
                                    });
                                }
                            },
                            error: function(data, err) {
                                console.log(err);
                                alert(JSON.stringify(data));
                                alert(JSON.stringify(err));
                            }
                        });
                    }
                }
            }
            //&&  'id' in $sel)
            //alert($sel.id);
            //https://jewishoffice.co.il/server/bookapi/?category=1&page=1&mode=name
        });
    });

    function addBook() {
        var sysid;
        var bname;

        var $sel = $('#books option:selected');

        if ($sel) {
            var opt = $sel[0];

            if ('id' in opt) {
                var id = opt.id;

                if (id > 0)
                    sysid = opt.id;
            }

            if ('innerText' in opt)
                bname = opt.innerText;
        }

        if (sysid && bname) {
            var endpoint = 'post_book.php';

            var jqxhr = $.post(endpoint, {
                    sys_id: sysid,
                    name: bname
                }, function() {
                    alert("success");
                })
                .done(function() {
                    //alert("second success");
                })
                .fail(function(err) {
                    //alert("error");
                    alert(JSON.stringify(err));
                })
                .always(function() {
                    //alert("finished");
                })
        }

        // Perform other work here ...

        // Set another completion function for the request above
        jqxhr.always(function() {
            //alert("second finished");
        });

        return;

        $.ajax({
            type: "POST",
            url: endpoint,
            contentType: "application/json",
            dataType: 'json',
            cache: false,
            data: {
                sys_id: 111,
                name: '111'
            },
            success: function(result) {
                console.log(result);
            },
            error: function(data, err) {
                console.log(err);
                alert(JSON.stringify(data));
                alert(JSON.stringify(err));
            }
        });
    }
</script>

<body>
    <select id="categories" dir="rtl">
        <option>None</option>
    </select>
    <br>
    <select id="books" dir="rtl">
        <option>None</option>
    </select>
    <br>
    <button class="btn-div" type="button" id="btnAddBook" onclick="return addBook();">
        הוסף ספר
        </button>
</body>

</html>