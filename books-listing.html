<!DOCTYPE html>
<html lang="en" style="direction: rtl;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tora</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="uni-scholars.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<script>
    $(document).ready(function() {
        initBook();

        $('#categories').change(function() {
            var $sel = $('#categories option:selected');

            if ($sel) { //} && Array.isArray($sel)) {
                var opt = $sel[0];

                if ('id' in opt) {
                    var id = opt.id;

                    if (id > 0) {
                        var endpoint = 'https://jewishoffice.co.il/server/bookapi/?category=' + id.toString() + '&page=1&mode=name';
                        $.ajax({
                            url: endpoint,
                            contentType: "application/json",
                            dataType: 'json',
                            cache: false,
                            success: function(result) {
                                console.log(result);

                                if ('books' in result) {
                                    var books = result.books;

                                    books.forEach(b => {
                                        if ('id' in b && 'name' in b) {
                                            str = '<option id=' + b.id.toString() + '>';
                                            str += b.name;
                                            str += '</a></option>';

                                            $('#books option:last').after(str);
                                        }
                                    });
                                }
                            },
                            error: function(data, err) {
                                console.log(err);
                                alert(JSON.stringify(data));
                                alert(JSON.stringify(err));
                            }
                        });
                    }
                }
            }
        });

        $('#books').change(function() {
            var $sel = $('#books option:selected');

            if ($sel) { //} && Array.isArray($sel)) {
                var opt = $sel[0];

                if ('id' in opt) {
                    var id = opt.id;

                    if (id > 0) {
                        var endpoint = 'https://jewishoffice.co.il/server/bookapi/?book=' + id.toString();

                        //window.location.replace('https://jewishoffice.co.il/server/bookapi/?category=' + id.toString() + '&page=1&mode=name');
                        $.ajax({
                            url: endpoint,
                            contentType: "application/json",
                            dataType: 'json',
                            cache: false,
                            success: function(result) {
                                console.log(result);

                                if ('books' in result) {
                                    var books = result.books;

                                    books.forEach(b => {
                                        if ('id' in b && 'name' in b) {
                                            str = '<option id=' + b.id.toString() + '>';
                                            str += b.name;
                                            str += '</a></option>';

                                            $('#books option:last').after(str);
                                        }
                                    });
                                }
                            },
                            error: function(data, err) {
                                console.log(err);
                                alert(JSON.stringify(data));
                                alert(JSON.stringify(err));
                            }
                        });
                    }
                }
            }
        });
    });

    function intGetBooks() {
        var endpoint = 'get_books.php?uid=1';

        $.ajax({
            url: endpoint,
            contentType: "application/json",
            dataType: 'json',
            cache: false,
            success: function(result) {
                console.log(result);

                if (Array.isArray(result)) {
                    result.forEach(book => {
                        if ('id' in book && 'category' in book && 'name' in book) {
                            str = '<tr>';
                            str += '<td>' + book.name + '</td>';
                            //str += '</a></option>';
                            str += '</tr>';

                            $('.div-int-books table tr:last').after(str);
                        }
                    });
                }
            },
            error: function(data, err) {
                console.log(err);
                //alert(JSON.stringify(data));
                //alert(JSON.stringify(err));
            }
        });

        endpoint = 'get_books.php';

        $.ajax({
            url: endpoint,
            contentType: "application/json",
            dataType: 'json',
            cache: false,
            success: function(result) {
                console.log(result);

                if (Array.isArray(result)) {
                    result.forEach(book => {
                        if ('id' in book && 'category' in book && 'name' in book) {
                            str = '<option id=' + book.id.toString() + '>';
                            str += book.name;
                            str += '</a></option>';

                            $('#int-books option:last').after(str);
                        }
                    });
                }
            },
            error: function(data, err) {
                console.log(err);
                //alert(JSON.stringify(data));
                //alert(JSON.stringify(err));
            }
        });
    }

    function extGetBooks() {
        var endpoint = 'https://jewishoffice.co.il/server/bookapi/?type=categories';

        $.ajax({
            url: endpoint,
            contentType: "application/json",
            dataType: 'json',
            cache: false,
            success: function(result) {
                console.log(result);

                if (Array.isArray(result)) {
                    result.forEach(cat => {
                        if ('ID' in cat && 'name' in cat) {
                            str = '<option id=' + cat.ID.toString() + '>';
                            str += cat.name;
                            str += '</a></option>';

                            $('#categories option:last').after(str);
                        }
                    });
                }
            },
            error: function(data, err) {
                console.log(err);
                alert(JSON.stringify(data));
                alert(JSON.stringify(err));
            }
        });
    }

    function initBook() {
        $('.div-int-books').show();
        $('.div-ext-books').hide();

        //$('.div-int-books').val("<option>בחר ספר</option>");

        intGetBooks();
    }

    function searchBook() {
        $('.div-int-books').hide();
        $('.div-ext-books').show();

        extGetBooks();
    }

    function intaddBook() {
        var achievements;
        var bookid;

        var optBook = $('#int-books option:selected')[0];

        if ('id' in optBook) {
            bookid = optBook.id;

            if (bookid > 0) {
                var endpoint = 'post_user_book.php';

                var jqxhr = $.post(endpoint, {
                        uid: 1, //userid,
                        bid: bookid
                    }, function() {
                        //alert("success");
                    })
                    .done(function() {
                        //alert("second success");
                    })
                    .fail(function(err) {
                        //alert(JSON.stringify(err));
                    })
                    .always(function() {
                        //alert("finished");
                        //initBook();
                        location.reload();
                    });
            }
        }
    }

    function addBook() {
        var bname;
        var bunits;
        var bdesc;
        var catid;
        var bookid;

        var optCat = $('#categories option:selected')[0];
        var optBook = $('#books option:selected')[0];

        if ('id' in optCat && 'id' in optBook) {
            catid = optCat.id;
            bookid = optBook.id;

            if (catid > 0 && bookid > 0) {
                if ('innerText' in optBook)
                    bname = optBook.innerText;

                bunits = $('#txtUnits').val();

                if (!bunits) {
                    var txt = $('#txtUnits')[0];

                    if ('placeholder' in txt)
                        bunits = txt.placeholder;

                    bdesc = $('#txtDescription').val();
                }
            }
        }

        if (catid > 0 && bookid > 0 && bname && bunits > 0) {
            var endpoint = 'post_book.php';

            var jqxhr = $.post(endpoint, {
                    sys_id: bookid,
                    name: bname,
                    units: bunits,
                    desc: bdesc,
                    cat: catid
                }, function() {
                    //alert("success");
                })
                .done(function() {
                    //alert("second success");
                })
                .fail(function(err) {
                    //alert(JSON.stringify(err));
                })
                .always(function() {
                    //alert("finished");
                    //initBook();
                    location.reload();
                });
        }
    }
</script>

<body>
    <header id="masthead" class="site-header grid-container grid-parent" itemtype="https://schema.org/WPHeader" itemscope="">
        <div class="inside-header grid-container grid-parent uni-scholars-header">
            <h1>איגוד לומדים עצמאיים</h1>
        </div>
    </header>
    <div class="div-int-books">
        <h2>רשימת הספרים שלך</h2>
        <table>
            <tr></tr>
        </table>
        <h2>בחר ספר ממאגר הספרים</h2>
        <!--
        <select id="int-categories" dir="rtl">
            <option>בחר קטגוריה</option>
        </select>
        <br>-->
        <select id="int-books" dir="rtl">
            <option>בחר ספר</option>
        </select>
        </br>
        <input type="number" id="txtAchievments" required placeholder="1" min="1" pattern="\d*">
        </input>
        </br>
        <button class="btn-div" type="button" id="intbtnAddBook" onclick="return intaddBook();">
            הוסף לרשימתך
        </button>
        <button class="btn-div" type="button" id="btnSearchBook" onclick="return searchBook();">
            חפש ספר
        </button>
    </div>
    <div class="div-ext-books">
        <h2>בחר ספר ממאגר האופיס היהודי</h2>
        <select id="categories" dir="rtl">
            <option>בחר קטגוריה</option>
        </select>
        <br>
        <select id="books" dir="rtl">
            <option>בחר ספר</option>
        </select>
        <br>
        <input type="number" id="txtUnits" required placeholder="1" min="1" pattern="\d*">
        </input>
        </br>
        <input type="text" id="txtDescription" placeholder="פרטי ספר">
        </input>
        </br>
        <button class="btn-div" type="button" id="btnAddBook" onclick="return addBook();">
            הוסף ספר
        </button>
    </div>
</body>

</html>